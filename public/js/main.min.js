$(function() {
	var app = {
		domCache: {},
		user: {},
	}
	var client = new ChatClient();

	client
		.on('connect', function() {
			console.info('connect');
		})
		.on('disconnect', function() {

			console.info('disconnect');
		})
		.on('message', function(data) {

			console.info('receive message');
			console.log(data);
		})
		.on('info.message', function(data) {

			console.info('info.message');
			console.log(data);
		})
		.on('info.login', function(data) {

			console.info('info.login');
			console.log(data);
		})
		.on('info.logout', function(data) {

			console.info('info.logout');
			console.log(data);
		})
		.on('record', function(data) {

			console.info('record');
			console.log(data);

			var friendName = '';
			if (!data.success || data.result.length === 0) return;
			if (data.result[0].from == client.cfg.name) {

				friendName = data.result[0].to;
			} else {

				friendName = data.result[0].from;
			}
			app.domCache[friendName] = new MessageListComponent(friendName);
			for (var i = 0; i < data.result.length; i++) {

				var message = data.result[i];
				if (message.from == friendName) {

					app.domCache[friendName].receive(message);
				} else {

					app.domCache[friendName].send(message);
				}
			}
		})

	$('.send-btn').click(function() {

		var content = $('.input-text').val().trim();
		if (content) {
			client.send({
				from: client.cfg.name,
				to: 'test-1',
				content: content,
				time: Date.now()
			})
		}
	});

	$.get('http://localhost:3003/users/getUser', function(res) {

		console.log(res)
		if (!res.success) {

			alert('用户登录失败')
			location.href = 'users/login'
		}
		app.user = res.user;
		client.init({
			url: 'http://127.0.0.1:3003',
			name: app.user.name,
			passwd: app.user.passwd,
			io: io, // socket.io
			friendList: app.user.friendList,
			blackList: app.user.blackList
		})
	})

	window.client = client;
	window.app = app;
})